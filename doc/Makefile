## Makefile to simplify Octave Forge package maintenance tasks
##
## Copyright 2015-2016 CarnÃ« Draug
## Copyright 2015-2016 Oliver Heimlich
## Copyright 2015-2019 Mike Miller
## Copyright 2024 John Donoghue
##
## Copying and distribution of this file, with or without modification,
## are permitted in any medium without royalty provided the copyright
## notice and this notice are preserved.  This file is offered as-is,
## without any warranty.

MKOCTFILE ?= mkoctfile
OCTAVE    ?= octave
SED       := sed
SHA256SUM := sha256sum
TAR       := tar
MAKEINFO  ?= makeinfo
# use --force in makeinfo since there are @refs to octave core functions
MAKEINFO_OPTIONS := --no-headers --no-split --no-validate \
												--set-customization-variable 'COPIABLE_LINKS 0'
PDFLATEX  ?= pdflatex
PDFLATEX_OPTIONS := -interaction batchmode

# work out a possible help generator
ifeq ($(strip $(QHELPGENERATOR)),)
  ifneq ($(shell qhelpgenerator -v 2>/dev/null),)
    QHELPGENERATOR = qhelpgenerator
  else ifneq ($(shell qcollectiongenerator -v 2>/dev/null),)
    QHELPGENERATOR = qcollectiongenerator-qt5
  else ifneq ($(shell qcollectiongenerator -qt5 -v 2>/dev/null),)
    QHELPGENERATOR = qcollectiongenerator -qt5
  else
    QHELPGENERATOR = true
  endif
endif

PACKAGE := $(shell $(SED) -n -e 's/^Name: *\(\w\+\)/\1/p' ../DESCRIPTION)
VERSION := $(shell $(SED) -n -e 's/^Version: *\(\w\+\)/\1/p' ../DESCRIPTION)
DATE := $(shell $(SED) -n -e 's/^Date: *\(\w\+\)/\1/p' ../DESCRIPTION)
DEPENDS := $(shell $(SED) -n -e 's/^Depends[^,]*, *\(.*\)/\1/p' ../DESCRIPTION | $(SED) 's/ *([^()]*)//g; s/ *, */ /g')

BASEDIR ?= $(realpath $(CURDIR))

RELEASE_DIR     := $(PACKAGE)-$(VERSION)
RELEASE_TARBALL := $(PACKAGE)-$(VERSION).tar.gz
HTML_DIR        := $(PACKAGE)-html
HTML_TARBALL    := $(PACKAGE)-html.tar.gz

.PHONY: all doc qch pdf clean maintainer-clean cleandocs

all: doc

help:
	@echo "Targets:"
	@echo "   doc              - Build Qt help file and pdf manual"
	@echo "   qch              - Build Qt help file"
	@echo "   pdf              - Build pdf manual"
	@echo "   clean            - Remove releases, html documentation, and oct files"
	@echo "   maintainer-clean - Additionally remove all generated files"
	@echo "   help             - This help"

version.texi: $(BASEDIR)/../DESCRIPTION
	@echo Generating $@
	@echo "@c autogenerated from Makefile" > $@
	@echo "@set VERSION $(VERSION)" >> $@
	@echo "@set PACKAGE $(PACKAGE)" >> $@
	@echo "@set DATE $(DATE)" >> $@

functions.texi: $(BASEDIR)/../.git/index
	@# For being abel to use amsmath syntax in latex snippets for the pdf,
	@# a latex document is required. This requires to change all *tex*
	@# conditionals into *latex* ones in all texinfo files
	@echo Collect all texinfo texts from the package...
	@./mkfuncdocs.py --src-dir=../inst/ --src-dir=../src/ ../INDEX > functions.texi
	@echo Do some syntax replacements...
	@./mkfunctexifix.pl functions.texi

$(PACKAGE).pdf: $(PACKAGE).texi functions.texi version.texi
	@echo Generating latex file...
	@$(MAKEINFO) --latex $(MAKEINFO_OPTIONS) $(PACKAGE).texi > /dev/null 2>&1
	@echo Compiling latex file...
	@$(PDFLATEX) $(PDFLATEX_OPTIONS) $(PACKAGE).tex > /dev/null 2>&1
	@$(PDFLATEX) $(PDFLATEX_OPTIONS) $(PACKAGE).tex > /dev/null 2>&1
	@$(PDFLATEX) $(PDFLATEX_OPTIONS) $(PACKAGE).tex > /dev/null 2>&1
	@echo Cleaning up...
	@$(RM) *.out *.log *.idx *.ilg *.ind *.toc *.cps *.aux *.fn *.fns*.out $(PACKAGE).tex

$(PACKAGE).qch: $(PACKAGE).texi functions.texi version.texi
	@# extract html
	@echo Generate html file...
	@$(MAKEINFO) --html --css-ref=$(PACKAGE).css $(MAKEINFO_OPTIONS) $(PACKAGE).texi
ifeq ($(QHELPGENERATOR),true)
	$(warning No QHELPGENERATOR... skipping QT doc build)
else
	@# try also create qch file if can
	@echo Generate qch file...
	@./mkqhcp.py $(PACKAGE) && $(QHELPGENERATOR) $(PACKAGE).qhcp -o $(PACKAGE).qhc
	@$(RM) $(PACKAGE).qhcp $(PACKAGE).qhp $(PACKAGE).qhc $(PACKAGE).html
endif

$(PACKAGE).info: $(PACKAGE).texi functions.texi version.texi
	$(MAKEINFO) $(PACKAGE).texi

qch: $(PACKAGE).qch

pdf: $(PACKAGE).pdf

doc: qch pdf

all: doc

clean:
	$(RM) $(PACKAGE).html
	$(RM) $(PACKAGE).qhc
	$(RM) $(PACKAGE).qch
	$(RM) $(PACKAGE).pdf
	$(RM) $(PACKAGE).info
	$(RM) $(PACKAGE).tex
	$(RM) functions.texi
	$(RM) version.texi
